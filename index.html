<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<title>QR Scanner Inventory PRO</title>

<style>
  body { margin: 0; font-family: sans-serif; background: #f4f4f9; padding-bottom: 80px; }
  #controls { padding: 12px; display: flex; gap: 8px; flex-wrap: wrap; position: sticky; top: 0; background: #f4f4f9; z-index: 10; border-bottom: 1px solid #ddd; }
  button { flex: 1 1 45%; padding: 14px; font-size: 14px; border-radius: 8px; border: none; background: #2f80ed; color: #fff; font-weight: bold; cursor: pointer; }
  button.secondary { background: #6c757d; }
  
  #videoContainer { display: none; position: fixed; top: 0; left: 0; z-index: 100; background: #000; width: 100%; height: 100%; }
  #video { width: 100%; height: 100%; object-fit: cover; }
  #closeVideo { position: absolute; top: 20px; right: 20px; z-index: 101; background: rgba(255,0,0,0.8); width: auto; }

  .table-wrapper { width: 100%; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
  th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 13px; }
  th { background: #eee; position: sticky; top: 0; }
  
  .db-loader { position: fixed; bottom: 0; left: 0; width: 100%; padding: 12px; background: #fff; border-top: 1px solid #ccc; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; gap: 5px; }
  #csvFile { display: none; }
  .status-bad { color: #d93025; font-weight: bold; }
  .status-ok { color: #188038; }
  #dbStatus { font-size: 11px; color: #666; }
</style>
</head>
<body>

<div id="controls">
  <button id="start">üì∏ –°–∫–∞–Ω QR</button>
  <button id="manualBtn" class="secondary">‚å®Ô∏è –í—Ä—É—á–Ω—É—é</button>
  <button id="remove" class="secondary">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
  <button id="exportBtn" style="background: #28a745;">üíæ –í—ã–≥—Ä—É–∑–∏—Ç—å CSV</button>
</div>

<div id="videoContainer">
  <button id="closeVideo">–ó–∞–∫—Ä—ã—Ç—å</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>‚Ññ</th>
        <th>–ö–æ–¥</th>
        <th>–î–æ–ø.</th>
        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
        <th>–û—Å—Ç–∞—Ç–æ–∫</th>
        <th>–Ø—á–µ–π–∫–∞</th>
        <th>–ö–æ–ª-–≤–æ</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div class="db-loader">
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="document.getElementById('csvFile').click()" style="background: #555; width: 90%; padding: 10px;">üìÇ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É —Ç–æ–≤–∞—Ä–æ–≤ (CSV)</button>
  <span id="dbStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

  const tableBody = document.getElementById("tableBody");
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });
  const dbStatus = document.getElementById('dbStatus');
  
  let stream = null;
  let scanning = false;
  let counter = 0;
  let productDatabase = {};

  // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –ò–ó –ü–ê–ú–Ø–¢–ò ---
  window.addEventListener('DOMContentLoaded', () => {
    const savedDb = localStorage.getItem('productDatabase');
    if (savedDb) {
      try {
        productDatabase = JSON.parse(savedDb);
        const count = Object.keys(productDatabase).length;
        dbStatus.innerText = `‚úÖ –ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ –ø–∞–º—è—Ç–∏ (${count} –ø–æ–∑.)`;
      } catch (e) {
        dbStatus.innerText = `‚ùå –û—à–∏–±–∫–∞ –ø–∞–º—è—Ç–∏. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª.`;
        console.error(e);
      }
    } else {
      dbStatus.innerText = `‚ùå –ë–∞–∑–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ.`;
    }
  });

  // --- –û–ë–†–ê–ë–û–¢–ö–ê –§–ê–ô–õ–ê ---
  document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      const text = event.target.result;
      const lines = text.split(/\r?\n/);
      const newDatabase = {};
      
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const columns = lines[i].split(';');
        
        if (columns.length >= 4) {
          const name = columns[0].trim();
          const qrCode = columns[1].trim().replace(/^0+/, '');
          const stock = columns[2].trim();
          const cell = columns[3].trim();
          newDatabase[qrCode] = { name, stock, cell };
        }
      }
      
      productDatabase = newDatabase;
      const count = Object.keys(productDatabase).length;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
      try {
        localStorage.setItem('productDatabase', JSON.stringify(productDatabase));
        dbStatus.innerText = `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø–∞–º—è—Ç—å: ${count} –ø–æ–∑.`;
        alert(`–ë–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`);
      } catch (e) {
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç—å: –±–∞–∑–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è.`);
        dbStatus.innerText = `‚ö†Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (${count} –ø–æ–∑.)`;
      }
    };
    reader.readAsText(file, 'UTF-8');
  });

  // --- –ö–ê–ú–ï–†–ê ---
  document.getElementById("start").onclick = async () => {
    try {
      document.getElementById("videoContainer").style.display = "block";
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.();
      if (caps?.zoom) {
        await track.applyConstraints({ advanced: [{ zoom: Math.min(2, caps.zoom.max) }] });
      }
      scanning = true;
      scan();
    } catch (e) { alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e); }
  };

  function stopCamera() {
    scanning = false;
    if (stream) stream.getTracks().forEach(t => t.stop());
    document.getElementById("videoContainer").style.display = "none";
  }

  document.getElementById("closeVideo").onclick = stopCamera;

  function scan() {
    if (!scanning) return;
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const qr = jsQR(img.data, img.width, img.height);
      if (qr) {
        processAndAdd(qr.data);
        stopCamera();
        return;
      }
    }
    requestAnimationFrame(scan);
  }

  // --- –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• ---
  document.getElementById("manualBtn").onclick = () => {
    const val = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç '–ö–æ–¥ -- –î–æ–ø':", "");
    if (val) processAndAdd(val);
  };

  function processAndAdd(rawData) {
    counter++;
    let code = rawData, extra = "-";
    if (rawData.includes("--")) {
      const parts = rawData.split("--");
      code = parts[0].trim();
      extra = parts[1].trim();
    }
    
    const cleanCode = code.replace(/^0+/, '') || "0";
    const info = productDatabase[cleanCode];

    if (info) {
      addRow(counter, code, extra, info.name, info.stock, info.cell, "OK");
    } else {
      addRow(counter, code, extra, "", "", "", "–ù–ï –ù–ê–ô–î–ï–ù!");
    }
  }

  function addRow(num, code, extra, name, stock, cell, status) {
    const tr = document.createElement("tr");
    const statusClass = status === "OK" ? "status-ok" : "status-bad";
    tr.innerHTML = `
      <td>${num}</td>
      <td>${code}</td>
      <td>${extra}</td>
      <td>${name}</td>
      <td>${stock}</td>
      <td>${cell}</td>
      <td contenteditable="true">1</td>
      <td class="${statusClass}">${status}</td>
    `;
    tableBody.appendChild(tr);
    tr.scrollIntoView({ behavior: "smooth" });
  }

  document.getElementById("remove").onclick = () => {
    if (tableBody.lastElementChild) {
      tableBody.removeChild(tableBody.lastElementChild);
      counter--;
    }
  };

  document.getElementById("exportBtn").onclick = () => {
    let csv = "\uFEFFN;–ö–æ–¥;–î–æ–ø;–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ;–û—Å—Ç–∞—Ç–æ–∫;–Ø—á–µ–π–∫–∞;–ö–æ–ª-–≤–æ;–°—Ç–∞—Ç—É—Å\n";
    document.querySelectorAll("#tableBody tr").forEach(tr => {
      const cols = Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
      csv += cols.join(";") + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `inventory_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  };
</script>
</body>
</html>
