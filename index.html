<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">
<title>QR Scanner</title>

<style>
  :root { --primary: #2f80ed; --bg: #f4f4f9; }
  
  body { margin: 0; font-family: sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  /* –í–µ—Ä—Ö–Ω—è—è —É–∑–∫–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ */
  #dbStatusStrip { 
    background: #333; color: #fff; font-size: 11px; padding: 4px 10px; 
    text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–µ—Ä—Ö—É */
  #topControls { padding: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; background: #fff; border-bottom: 1px solid #ddd; }
  
  #topControls button { padding: 10px 4px; font-size: 11px; border-radius: 6px; border: none; background: #6c757d; color: #fff; font-weight: bold; }
  #topControls button.db-btn { background: #555; }
  #topControls button.export-btn { background: #28a745; }

  /* –¢–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
  .table-wrapper { flex: 1; overflow: auto; background: #fff; }
  table { width: 100%; border-collapse: collapse; min-width: 500px; }
  th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 12px; }
  th { background: #f8f9fa; position: sticky; top: 0; z-index: 2; }

  /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º */
  #bottomBar { padding: 12px; background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: center; }
  #startScan { width: 100%; max-width: 400px; padding: 16px; font-size: 18px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-weight: bold; box-shadow: 0 4px 12px rgba(47,128,237,0.3); }

  /* –û–≤–µ—Ä–ª–µ–π –∫–∞–º–µ—Ä—ã */
  #videoContainer { display: none; position: fixed; top: 0; left: 0; z-index: 100; background: #000; width: 100%; height: 100%; }
  #video { width: 100%; height: 100%; object-fit: cover; }
  #closeVideo { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 101; background: rgba(255, 59, 48, 0.9); padding: 16px 40px; border-radius: 30px; color: white; border: none; font-size: 16px; font-weight: bold; }

  .status-bad { color: #d93025; font-weight: bold; }
  .status-ok { color: #188038; }
</style>
</head>
<body>

<div id="dbStatusStrip">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...</div>

<div id="topControls">
  <button class="db-btn" onclick="document.getElementById('csvFile').click()">üìÇ –ë–∞–∑–∞</button>
  <button onclick="manualInput()">‚å®Ô∏è –í–≤–æ–¥</button>
  <button onclick="removeLast()">üóëÔ∏è –£–¥–∞–ª.</button>
  <button class="export-btn" onclick="exportCSV()">üíæ CSV</button>
</div>

<input type="file" id="csvFile" accept=".csv" style="display:none">

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>‚Ññ</th><th>–ö–æ–¥</th><th>–î–æ–ø</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–û—Å—Ç.</th><th>–Ø—á.</th><th>–ö–æ–ª</th><th>–°—Ç–∞—Ç—É—Å</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="bottomBar">
  <button id="startScan">üì∏ –û–¢–ö–†–´–¢–¨ –°–ö–ê–ù–ï–†</button>
</div>

<div id="videoContainer">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
  <button id="closeVideo">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script src="./jsQR.js"></script>
<script>
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW
  if ('serviceWorker' in navigator) { 
    navigator.serviceWorker.register('sw.js').then(reg => {
      reg.onupdatefound = () => {
        const installingWorker = reg.installing;
        installingWorker.onstatechange = () => {
          if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
            if(confirm("–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å?")) window.location.reload();
          }
        };
      };
    });
  }

  const tableBody = document.getElementById("tableBody");
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });
  const dbStatus = document.getElementById('dbStatusStrip');
  
  let stream = null;
  let scanning = false;
  let counter = 0;
  let productDatabase = {};

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ø–∞–º—è—Ç–∏
  window.addEventListener('DOMContentLoaded', () => {
    const savedDb = localStorage.getItem('productDatabase');
    if (savedDb) {
      productDatabase = JSON.parse(savedDb);
      dbStatus.innerText = `‚úÖ –ë–î: ${Object.keys(productDatabase).length} –ø–æ–∑. (–∏–∑ –ø–∞–º—è—Ç–∏)`;
    } else {
      dbStatus.innerText = `‚ùå –ë–∞–∑–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞`;
    }
  });

  // –§–∞–π–ª CSV
  document.getElementById('csvFile').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      const lines = event.target.result.split(/\r?\n/);
      const newDb = {};
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(';');
        if (cols.length >= 4) {
          const code = cols[1].trim().replace(/^0+/, '');
          newDb[code] = { name: cols[0].trim(), stock: cols[2].trim(), cell: cols[3].trim() };
        }
      }
      productDatabase = newDb;
      localStorage.setItem('productDatabase', JSON.stringify(newDb));
      dbStatus.innerText = `‚úÖ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞: ${Object.keys(newDb).length} –ø–æ–∑.`;
      alert("–ë–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
    };
    reader.readAsText(file, 'UTF-8');
  };

  // –°–∫–∞–Ω–µ—Ä
  document.getElementById("startScan").onclick = async () => {
    try {
      document.getElementById("videoContainer").style.display = "block";
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.();
      if (caps?.zoom) await track.applyConstraints({ advanced: [{ zoom: Math.min(2, caps.zoom.max) }] });
      scanning = true;
      requestAnimationFrame(scan);
    } catch (e) { alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e); }
  };

  function scan() {
    if (!scanning) return;
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const qr = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
      if (qr) { processAndAdd(qr.data); return stopCamera(); }
    }
    requestAnimationFrame(scan);
  }

  function stopCamera() {
    scanning = false;
    if (stream) stream.getTracks().forEach(t => t.stop());
    document.getElementById("videoContainer").style.display = "none";
  }

  document.getElementById("closeVideo").onclick = stopCamera;

  function manualInput() {
    const val = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:");
    if (val) processAndAdd(val);
  }

  function processAndAdd(rawData) {
    counter++;
    let code = rawData, extra = "-";
    if (rawData.includes("--")) {
      const parts = rawData.split("--");
      code = parts[0].trim(); extra = parts[1].trim();
    }
    const info = productDatabase[code.replace(/^0+/, '')];
    addRow(counter, code, extra, info);
  }

  function addRow(num, code, extra, info) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${num}</td><td>${code}</td><td>${extra}</td>
      <td>${info ? info.name : ''}</td><td>${info ? info.stock : ''}</td><td>${info ? info.cell : ''}</td>
      <td contenteditable="true">1</td>
      <td class="${info ? 'status-ok' : 'status-bad'}">${info ? 'OK' : '–ù–ï –ù–ê–ô–î–ï–ù!'}</td>
    `;
    tableBody.appendChild(tr);
    tr.scrollIntoView({ behavior: "smooth" });
  }

  function removeLast() {
    if (tableBody.lastElementChild) { tableBody.removeChild(tableBody.lastElementChild); counter--; }
  }

  function exportCSV() {
    let csv = "\uFEFFN;–ö–æ–¥;–î–æ–ø;–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ;–û—Å—Ç–∞—Ç–æ–∫;–Ø—á–µ–π–∫–∞;–ö–æ–ª-–≤–æ;–°—Ç–∞—Ç—É—Å\n";
    document.querySelectorAll("#tableBody tr").forEach(tr => {
      csv += Array.from(tr.querySelectorAll("td")).map(td => td.innerText).join(";") + "\n";
    });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
    a.download = `inventory_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  }
</script>
</body>
</html>
